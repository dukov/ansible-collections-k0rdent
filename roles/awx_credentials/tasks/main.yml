---
# Main tasks for awx_credentials role

- name: Validate awx_credentials is a list
  assert:
    that:
      - awx_credentials is defined
      - awx_credentials is iterable
    fail_msg: "awx_credentials must be defined as a list"
    quiet: true

- name: Create or update AWX credentials
  awx.awx.credential:
    name: "{{ item.name }}"
    credential_type: "{{ item.credential_type | default(awx_credential_defaults.credential_type) }}"
    organization: "{{ item.organization | default(omit) }}"
    description: "{{ item.description | default(omit) }}"
    inputs: "{{ credential_inputs }}"
    state: "{{ item.state | default(awx_credential_defaults.state) }}"
    user: "{{ awx_username }}"
    controller_host: "{{ awx_host }}"
    controller_username: "{{ awx_username }}"
    controller_password: "{{ awx_password | default(omit) }}"
    controller_oauthtoken: "{{ awx_token | default(omit) }}"
    validate_certs: "{{ awx_validate_certs }}"
  vars:
    # Load SSH key from file if ssh_key_path is provided
    _ssh_key_from_file: "{{ lookup('file', item.ssh_key_path) if (item.ssh_key_path is defined and item.ssh_key is not defined) else '' }}"
    # Use SSH key from variable, file, or empty string
    _ssh_key: "{{ item.ssh_key | default(_ssh_key_from_file) }}"
    # Build inputs dictionary - start with username if available
    _inputs_username: "{{ {'username': item.username | default(awx_credential_defaults.username)} if (item.username is defined or awx_credential_defaults.username is defined) else {} }}"
    # Add SSH key if available
    _inputs_ssh: "{{ {'ssh_key_data': _ssh_key} if (_ssh_key is defined and _ssh_key | length > 0) else {} }}"
    # Combine all inputs
    credential_inputs: "{{ _inputs_username | combine(_inputs_ssh) }}"
  loop: "{{ awx_credentials }}"
  loop_control:
    label: "{{ item.name }}"
  no_log: true
  when: awx_credentials | length > 0
